<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VR Filename Tool</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; }
      header { padding: 16px 20px; border-bottom: 1px solid #ddd; }
      h1 { font-size: 18px; margin: 0; }
      main { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px; }
      .panel { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
      label { display: block; font-weight: 600; margin: 6px 0; }
      select, button { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      ul { list-style: none; padding-left: 0; margin: 0; max-height: 260px; overflow: auto; border: 1px solid #eee; border-radius: 6px; }
      li { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-bottom: 1px solid #f2f2f2; cursor: pointer; }
      li:last-child { border-bottom: none; }
      li:hover { background-color: #f8f8f8; }
      .file-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .folder-icon { color: #ffa500; font-weight: bold; }
      .file-icon { color: #666; }
      .preview { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      footer { padding: 12px 16px; border-top: 1px solid #ddd; display: flex; align-items: center; gap: 12px; }
      .status { font-size: 12px; opacity: .8; }
    </style>
  </head>
  <body>
    <header>
      <h1>VR Filename Tool</h1>
    </header>
    <main>
      <section class="panel">
        <label for="player">VR Player</label>
        <select id="player"></select>
        <label for="pattern">Naming Convention</label>
        <select id="pattern"></select>
      </section>
      <section class="panel">
        <div class="row">
          <div>
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <label style="margin: 0;">RAW MP4 files (raw/)</label>
              <button id="showAllBtn" style="padding: 4px 8px; font-size: 12px;">Show All</button>
              <button id="browseBtn" style="padding: 4px 8px; font-size: 12px;">Browse</button>
              <button id="selectAllBtn" style="padding: 4px 8px; font-size: 12px;">Select All</button>
            </div>
            <div id="breadcrumb" style="font-size: 12px; margin-bottom: 8px; color: #666;"></div>
            <ul id="files"></ul>
          </div>
          <div>
            <label>Preview new names (fixed_metadata/)</label>
            <ul id="preview"></ul>
          </div>
        </div>
      </section>
    </main>
    <footer>
      <button id="exportBtn">Export renamed copies</button>
      <div class="status" id="status"></div>
    </footer>

    <script>
      const byId = (id) => document.getElementById(id);
      const playerSel = byId('player');
      const patternSel = byId('pattern');
      const filesUl = byId('files');
      const previewUl = byId('preview');
      const statusEl = byId('status');
      const exportBtn = byId('exportBtn');
      const showAllBtn = byId('showAllBtn');
      const browseBtn = byId('browseBtn');
      const selectAllBtn = byId('selectAllBtn');
      const breadcrumbEl = byId('breadcrumb');

      let currentFiles = [];
      let currentDirectory = '';
      let isShowingAll = false;

      async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Request failed');
        return res.json();
      }

      function renderFiles(data) {
        filesUl.innerHTML = '';
        
        if (isShowingAll) {
          // Show all MP4 files recursively
          for (const f of data.all_mp4_files) {
            const li = document.createElement('li');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.checked = true;
            cb.dataset.filename = f;
            const icon = document.createElement('span');
            icon.className = 'file-icon';
            icon.textContent = 'ðŸ“„';
            const span = document.createElement('span');
            span.className = 'file-name';
            span.textContent = f;
            li.appendChild(cb);
            li.appendChild(icon);
            li.appendChild(span);
            filesUl.appendChild(li);
          }
        } else {
          // Show folders first, then files
          for (const folder of data.folders) {
            const li = document.createElement('li');
            const icon = document.createElement('span');
            icon.className = 'folder-icon';
            icon.textContent = 'ðŸ“';
            const span = document.createElement('span');
            span.className = 'file-name';
            span.textContent = folder;
            li.dataset.folder = folder;
            li.appendChild(icon);
            li.appendChild(span);
            filesUl.appendChild(li);
          }
          
          for (const f of data.files) {
            const li = document.createElement('li');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.checked = true;
            cb.dataset.filename = f;
            const icon = document.createElement('span');
            icon.className = 'file-icon';
            icon.textContent = 'ðŸ“„';
            const span = document.createElement('span');
            span.className = 'file-name';
            span.textContent = f;
            li.appendChild(cb);
            li.appendChild(icon);
            li.appendChild(span);
            filesUl.appendChild(li);
          }
        }
        
        // Update the select all button state after rendering
        updateSelectAllButton();
      }

      function getSelectedFiles() {
        const boxes = filesUl.querySelectorAll('input[type="checkbox"]');
        const out = [];
        boxes.forEach(b => { 
          if (b.checked) {
            const filename = b.dataset.filename;
            // If we're in a subdirectory, prepend the current directory path
            if (currentDirectory && !isShowingAll) {
              out.push(currentDirectory + '/' + filename);
            } else {
              out.push(filename);
            }
          }
        });
        return out;
      }

      function updateBreadcrumb() {
        if (isShowingAll) {
          breadcrumbEl.textContent = 'All MP4 files (recursive)';
        } else if (currentDirectory) {
          breadcrumbEl.textContent = `raw/${currentDirectory}/`;
        } else {
          breadcrumbEl.textContent = 'raw/';
        }
      }

      function toggleAllFiles() {
        const checkboxes = filesUl.querySelectorAll('input[type="checkbox"]');
        if (checkboxes.length === 0) return;
        
        // Check if all files are currently selected
        const allSelected = Array.from(checkboxes).every(cb => cb.checked);
        
        // Toggle all checkboxes
        checkboxes.forEach(cb => {
          cb.checked = !allSelected;
        });
        
        // Update button text
        selectAllBtn.textContent = allSelected ? 'Select All' : 'Deselect All';
        
        // Refresh preview
        refreshPreview();
      }

      function updateSelectAllButton() {
        const checkboxes = filesUl.querySelectorAll('input[type="checkbox"]');
        if (checkboxes.length === 0) {
          selectAllBtn.textContent = 'Select All';
          return;
        }
        
        const allSelected = Array.from(checkboxes).every(cb => cb.checked);
        const someSelected = Array.from(checkboxes).some(cb => cb.checked);
        
        if (allSelected) {
          selectAllBtn.textContent = 'Deselect All';
        } else if (someSelected) {
          selectAllBtn.textContent = 'Select All';
        } else {
          selectAllBtn.textContent = 'Select All';
        }
      }

      async function refreshPreview() {
        previewUl.innerHTML = '';
        const pattern = patternSel.value || '';
        const files = getSelectedFiles();
        if (!pattern || files.length === 0) return;
        const res = await fetch('/api/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pattern, files })
        });
        const data = await res.json();
        for (const row of data.preview) {
          const li = document.createElement('li');
          li.className = 'preview';
          li.textContent = `${row.original} â†’ ${row.new}`;
          previewUl.appendChild(li);
        }
      }

      async function loadPlayers() {
        const data = await fetchJSON('/api/players');
        playerSel.innerHTML = '';
        for (const p of data.players) {
          const opt = document.createElement('option');
          opt.value = p; opt.textContent = p;
          playerSel.appendChild(opt);
        }
        
        // Set PLAY'A VR as the default selection
        const playaVrOption = Array.from(playerSel.options).find(opt => opt.value === "PLAY'A VR");
        if (playaVrOption) {
          playerSel.value = "PLAY'A VR";
        }
        
        playerSel.dispatchEvent(new Event('change'));
      }

      async function loadConventions(player) {
        patternSel.innerHTML = '';
        const data = await fetchJSON(`/api/conventions?player=${encodeURIComponent(player)}`);
        for (const pat of data.patterns) {
          const opt = document.createElement('option');
          opt.value = pat; opt.textContent = pat;
          patternSel.appendChild(opt);
        }
        await refreshPreview();
      }

      async function loadFiles() {
        const url = currentDirectory ? `/api/files?subdir=${encodeURIComponent(currentDirectory)}` : '/api/files';
        const data = await fetchJSON(url);
        currentFiles = data.files;
        renderFiles(data);
        updateBreadcrumb();
        await refreshPreview();
      }

      playerSel.addEventListener('change', async () => {
        await loadConventions(playerSel.value);
      });

      patternSel.addEventListener('change', async () => {
        await refreshPreview();
      });

      filesUl.addEventListener('change', async (e) => {
        if (e.target && e.target.matches('input[type="checkbox"]')) {
          updateSelectAllButton();
          await refreshPreview();
        }
      });

      filesUl.addEventListener('click', async (e) => {
        const li = e.target.closest('li');
        if (li && li.dataset.folder) {
          // Navigate into folder
          currentDirectory = currentDirectory ? `${currentDirectory}/${li.dataset.folder}` : li.dataset.folder;
          isShowingAll = false;
          await loadFiles();
        }
      });

      showAllBtn.addEventListener('click', async () => {
        isShowingAll = true;
        await loadFiles();
      });

      browseBtn.addEventListener('click', async () => {
        isShowingAll = false;
        currentDirectory = '';
        await loadFiles();
      });

      selectAllBtn.addEventListener('click', () => {
        toggleAllFiles();
      });

      breadcrumbEl.addEventListener('click', async () => {
        if (currentDirectory) {
          // Go back to parent directory
          const parts = currentDirectory.split('/');
          parts.pop();
          currentDirectory = parts.join('/');
          isShowingAll = false;
          await loadFiles();
        }
      });

      exportBtn.addEventListener('click', async () => {
        statusEl.textContent = 'Exporting...';
        try {
          const pattern = patternSel.value || '';
          const files = getSelectedFiles();
          const res = await fetch('/api/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pattern, files })
          });
          const data = await res.json();
          const ok = data.results.filter(r => r.status === 'ok');
          statusEl.textContent = `Done. ${ok.length} file(s) exported to fixed_metadata/`;
        } catch (err) {
          statusEl.textContent = 'Export failed';
        }
      });

      (async function init() {
        await loadPlayers();
        await loadFiles();
      })();
    </script>
  </body>
  </html>


